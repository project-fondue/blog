<!DOCTYPE html>
<html lang="en">
<head>
        
        <title>L'Alpiniste</title>
        <meta charset="utf-8" />
        
        <link href='http://fonts.googleapis.com/css?family=Fugaz+One' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/normalize.css" type="text/css" />
        <link rel="stylesheet" href="/theme/css/griddles-mq.css" type="text/css" />
        <link rel="stylesheet" href="/theme/css/style.css" type="text/css" />
</head>

<body>
    <div class="banner"></div>
    <div id="latest-tweet"></div>

    <div class="content-wrapper grid gutter">
        <section class="main g-3/4 m-g-100" role="main">
            <header>
                <a class="title" href="http://blog.projectfondue.com:9901">L'Alpiniste</a>
                <p><strong>The blog of the Project Fondue Team</strong></p>
            </header><!-- /#banner -->

            <nav id="menu">
                <ul>
                    
            
                
            
                </ul>
            </nav><!-- /#menu -->

            
    <header>
        <h1 class="entry-title"><a href="" rel="bookmark" title="Permalink to Apache: Moving from prefork to worker">Apache: Moving from prefork to worker</a></h1>
    </header>
    <div class="post-info">
        <abbr class="published" title="2010-03-04T23:23:00">
                Thu 04 March 2010
        </abbr>
        
        <p class="vcard author">
            By <a class="url fn" href="/author/Project Fondue Team">Project Fondue Team</a>
        </p>
        
    </div><!-- /.post-info -->
    <div class="entry-content">
    <p>In this post we look at the results of moving our Apache from mpm-prefork to mpm-worker for Python based web-apps in an attempt to reduce memory usage.</p>
<div class="section" id="differences-between-mpm-versions">
<h2>Differences between MPM Versions</h2>
<p>So what are the differences between Apache MPM (&quot;multi-processing module&quot;) types?</p>
<p>MPM Prefork doesn't use threads and instead spawns child processes to serve requests. MPM Worker on the other hand uses multi-threaded processes where each child process utilises a number of threads:</p>
<blockquote>
<p>By using threads to serve requests, it is able to serve a large number of requests with less system resources than a process-based server. Yet it retains much of the stability of a process-based server by keeping multiple processes available, each with many threads.</p>
<p class="attribution">&mdash;Apache 2 Documentation</p>
</blockquote>
<p>Something to bear in mind is that you probably won't want to switch to worker if you are using PHP unless you are ok with using PHP as FastCGI and even then the <a class="reference external" href="http://www.php.net/manual/en/faq.installation.php#faq.installation.apache2">PHP manual doesn't recommend using MPM worker.</a></p>
<p>For us that means we are now running our PHP apps using prefork and mod_php on a box dedicated to running PHP. This is better in a lot of ways because it means we can tune Apache for each specific application rather than running a mixture of PHP and Python apps on the same hardware.</p>
</div>
<div class="section" id="converting-to-mpm-worker">
<h2>Converting to mpm-worker</h2>
<p>Actually carrying out the conversion on an Ubuntu box is as simple as running</p>
<div class="highlight"><pre>sudo apt-get install apache2-mpm-worker
</pre></div>
<p>That will remove prefork if you have it installed and will install worker in its place and trigger a restart. That's all there is to it. (Though of course YMMV)</p>
</div>
<div class="section" id="what-difference-does-it-make">
<h2>What Difference does it make?</h2>
<p>In our case used memory levels dropped a reasonable amount as you can see in the last 6th of this graph:</p>
<img alt="Graph Showing memory usage down when switched to MPM worker" src="http://pf.staticfil.es/blog/images/radha.png" />
<div class="section" id="related-reading">
<h3>Related Reading</h3>
<ul class="simple">
<li><a class="reference external" href="http://lucumr.pocoo.org/2007/9/30/pushing-apache-performance">Pushing Apache Performance</a></li>
<li><a class="reference external" href="http://httpd.apache.org/docs/2.2/mpm.html">Multi-Processing Modules (MPMs)</a></li>
</ul>
</div>
</div>

    </div><!-- /.entry-content -->
    <div id="disqus_thread"></div>

        </section>

        
        <aside class="sidebar g-1/4 m-g-100">
            <h3><span>Feed your head</span></h3>
            <ul>
                <li><a href="http://twitter.com/projectfondue">Follow us on Twitter</a></li>
            </ul>

            <h3><span>Latest Posts</span></h3>
            <ul>
                
                <li><a href="/archives/2011/06/06/the-web-column-issue-no5">The Web Column: Issue No.5</a></li>
                
                <li><a href="/archives/2011/02/09/the-web-column-issue-no4">The Web Column: Issue No.4</a></li>
                
                <li><a href="/archives/2011/02/08/contribute-to-the-web-column">Contribute to the Web Column</a></li>
                
                <li><a href="/archives/2011/01/18/the-web-column-issue-no3">The Web Column: Issue No.3</a></li>
                
                <li><a href="/archives/2011/01/14/the-web-column-issue-no2">The Web Column: Issue No.2</a></li>
                
            </ul>

            

            <h3><span>Tags</span></h3>
            <ul class="tags">
                
                    <li class="tag-10"><a href="/tag/performance/">performance</a></li>
                
                    <li class="tag-10"><a href="/tag/accessibility/">accessibility</a></li>
                
                    <li class="tag-10"><a href="/tag/cron/">cron</a></li>
                
                    <li class="tag-1"><a href="/tag/web-column/">web-column</a></li>
                
                    <li class="tag-10"><a href="/tag/browsers/">browsers</a></li>
                
                    <li class="tag-10"><a href="/tag/scaling/">scaling</a></li>
                
                    <li class="tag-10"><a href="/tag/linux/">linux</a></li>
                
                    <li class="tag-10"><a href="/tag/restructuredtext/">restructuredtext</a></li>
                
                    <li class="tag-10"><a href="/tag/haproxy/">haproxy</a></li>
                
                    <li class="tag-2"><a href="/tag/python/">python</a></li>
                
                    <li class="tag-10"><a href="/tag/glusterfs/">glusterfs</a></li>
                
                    <li class="tag-10"><a href="/tag/css/">css</a></li>
                
                    <li class="tag-3"><a href="/tag/apache/">apache</a></li>
                
                    <li class="tag-6"><a href="/tag/wsgi/">wsgi</a></li>
                
                    <li class="tag-6"><a href="/tag/mod_wsgi/">mod_wsgi</a></li>
                
                    <li class="tag-10"><a href="/tag/nginx/">nginx</a></li>
                
                    <li class="tag-10"><a href="/tag/google/">google</a></li>
                
                    <li class="tag-10"><a href="/tag/announcements/">announcements</a></li>
                
                    <li class="tag-10"><a href="/tag/loggerhead/">loggerhead</a></li>
                
                    <li class="tag-10"><a href="/tag/devops/">devops</a></li>
                
            </ul>

            <h3><span>More Fondue</span></h3>
            <ul>
                <li><a href="http://spritegen.website-performance.org">CSS Sprite Generator</a></li>
                <li><a href="http://favicon-generator.org">Favicon Generator</a></li>
                <li><a href="http://permissions-calculator.org">Unix Permissions Calculator</a></li>
            </ul>


        </aside>
        
    </div>

    <footer id="contentinfo" class="body" role="contentinfo">
        <p class="powered">Proudly powered by <a href="http://docs.notmyidea.org/alexis/pelican/">pelican</a></p>
        <p class="copyright">&copy; Copyright 2008-2012 by <a href="http://projectfondue.com/">Project Fondue</a>.</p>
    </footer><!-- /#contentinfo -->

    

<script type="text/javascript">
    var disqus_shortname = 'projectfondue';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>


    <script src="/theme/js/lscache.js"></script>
    <script src="/theme/js/latest-tweet.js"></script>
</body>
</html>