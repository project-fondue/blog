<!DOCTYPE html>
<html lang="en">
<head>
        
        <title>L'Alpiniste</title>
        <meta charset="utf-8" />
        
        <link href='http://fonts.googleapis.com/css?family=Fugaz+One' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/normalize.css" type="text/css" />
        <link rel="stylesheet" href="/theme/css/griddles-mq.css" type="text/css" />
        <link rel="stylesheet" href="/theme/css/style.css" type="text/css" />
</head>

<body>
    <div class="banner"></div>
    <div id="latest-tweet"></div>

    <div class="content-wrapper grid gutter">
        <section class="main g-3/4 m-g-100" role="main">
            <header>
                <a class="title" href="http://blog.projectfondue.com:9901">L'Alpiniste</a>
                <p><strong>The blog of the Project Fondue Team</strong></p>
            </header><!-- /#banner -->

            <nav id="menu">
                <ul>
                    
            
                
            
                </ul>
            </nav><!-- /#menu -->

            
    <header>
        <h1 class="entry-title"><a href="" rel="bookmark" title="Permalink to Getting an Early Warning of Low Disk Space">Getting an Early Warning of Low Disk Space</a></h1>
    </header>
    <div class="post-info">
        <abbr class="published" title="2010-01-21T23:51:00">
                Thu 21 January 2010
        </abbr>
        
        <p class="vcard author">
            By <a class="url fn" href="/author/Project Fondue Team">Project Fondue Team</a>
        </p>
        
    </div><!-- /.post-info -->
    <div class="entry-content">
    <p>Here's a really simple way of getting a notification when your disk space is running low by using a simple Python script in a cron job.</p>
<p>The idea is to configure a script with a threshold at which point if your free disk space is less that &quot;n&quot; percent you'll get an email telling you that you're running low on disk space.</p>
<div class="section" id="keeping-an-eye-on-disk-space">
<h2>Keeping an eye on Disk Space</h2>
<p>Running out of disk space is not a good situation to be in. Services that run out of disk space can cause your server to blow up in a very short space of time. As a result of that it's a good idea to get an early warning that your machine is on it's way to running out of disk space. This script is a noddy way to get that insight with minimum effort.</p>
<div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Disk Space</span>
<span class="sd">Simple class for working out the free disk space on a system</span>

<span class="sd">by Stuart Colville http://muffinresearch.co.uk</span>
<span class="sd">License: http://www.opensource.org/licenses/mit-license.php</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">class</span> <span class="nc">DiskSpace</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;Free Disk Space&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init class and retrieves disk space info&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">statvfs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_free_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bool returns true if remaining space is above limit %&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percent_free</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">percent_free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets the amount of space left as a percentage&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bytes_capacity</span><span class="p">())</span>
                                                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_free</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">bytes_capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the total capacity in bytes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_frsize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_blocks</span>

    <span class="k">def</span> <span class="nf">bytes_free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the free space in bytes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_frsize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_bavail</span>

    <span class="k">def</span> <span class="nf">bytes_used</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the used space in bytes&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_frsize</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_blocks</span> <span class="o">-</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">disk</span><span class="o">.</span><span class="n">f_bavail</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">humanize_bytes</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">kilo</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Humanizes bytes</span>

<span class="sd">        See http://en.wikipedia.org/wiki/Kilobyte for info on the</span>
<span class="sd">        different ways to interpret whether a kilobyte is 1,024 bytes</span>
<span class="sd">        or 1,000 bytes</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">kilo</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;KiB&quot;</span><span class="p">,</span> <span class="s">&quot;MiB&quot;</span> <span class="p">,</span> <span class="s">&quot;GiB&quot;</span><span class="p">,</span> <span class="s">&quot;TiB&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># fallback</span>
            <span class="n">kilo</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;KB&quot;</span><span class="p">,</span> <span class="s">&quot;MB&quot;</span> <span class="p">,</span> <span class="s">&quot;GB&quot;</span><span class="p">,</span> <span class="s">&quot;TB&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">bytes</span> <span class="o">&lt;</span> <span class="n">kilo</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">bytes</span>
        <span class="k">elif</span> <span class="nb">bytes</span> <span class="o">&gt;</span> <span class="n">kilo</span> <span class="ow">and</span> <span class="nb">bytes</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%.2F%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">bytes</span><span class="o">/</span><span class="n">kilo</span><span class="p">),</span> <span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">bytes</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bytes</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%.2F%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">bytes</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">bytes</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bytes</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%.2F%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">bytes</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">label</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">bytes</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bytes</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%.2F%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">bytes</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">kilo</span><span class="p">,</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">label</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<div class="section" id="example">
<h2>Example</h2>
<p>Here's a quick example of how this can be used in practice</p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;Simple example command line usage:</span>

<span class="sd">Usage: ./check_disk_space.py &lt;percentage free space&gt;</span>

<span class="sd">e.g:</span>

<span class="sd">$ ./check_disk_space.py 30</span>
<span class="sd">Running low on disk space. 20.0% remaining (Warning Threshold: 30%)</span>
<span class="sd">Total: 115.13GB</span>
<span class="sd">Used:  92.35GB</span>
<span class="sd">Avail: 22.77GB</span>

<span class="sd">The idea would be to put this in a Cron Job and have it email you when</span>
<span class="sd">the free disk space is lower than &quot;n&quot; percent.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;../&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">diskspace</span> <span class="kn">import</span> <span class="n">DiskSpace</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">DiskSpace</span><span class="p">()</span>

<span class="n">perc_arg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span>
<span class="n">percent_limit</span> <span class="o">=</span> <span class="n">perc_arg</span> <span class="ow">or</span> <span class="mi">20</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">ds</span><span class="o">.</span><span class="n">has_free_space</span><span class="p">(</span><span class="n">percent_limit</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Running low on disk space. </span><span class="si">%s%%</span><span class="s"> remaining &quot;</span>\
       <span class="s">&quot;(Warning Threshold: </span><span class="si">%s%%</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">percent_free</span><span class="p">(),</span> <span class="n">percent_limit</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Total: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ds</span><span class="o">.</span><span class="n">humanize_bytes</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">bytes_capacity</span><span class="p">(),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Used:  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ds</span><span class="o">.</span><span class="n">humanize_bytes</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">bytes_used</span><span class="p">(),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Avail: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ds</span><span class="o">.</span><span class="n">humanize_bytes</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">bytes_free</span><span class="p">(),</span> <span class="mi">1000</span><span class="p">)</span>
</pre></div>
<p>This last file can be saved as check_disk_space.py and made executable with:</p>
<div class="highlight"><pre>chmod +x check_disk_space.py
</pre></div>
<p>All you then need to do is add a crontab entry and define the limit at which you want to be warned of impending disk space running out.</p>
<div class="highlight"><pre>MAILTO=systems@yourdomain.com
0 */2 * * * /path/to/file/free_disk_space 15
</pre></div>
<p>This example will check the space every 2 hours and will email you when the remaining disk space drops below 15%.</p>
<p>A Branch of these files is available here: <a class="reference external" href="http://code.projectfondue.com/diskspace/trunk/files/head:/diskspace/">http://code.projectfondue.com/diskspace/trunk/files/head:/diskspace/</a></p>
<p>Suggestions for improvement are always welcome.</p>
</div>

    </div><!-- /.entry-content -->
    <div id="disqus_thread"></div>

        </section>

        
        <aside class="sidebar g-1/4 m-g-100">
            <h3><span>Feed your head</span></h3>
            <ul>
                <li><a href="http://twitter.com/projectfondue">Follow us on Twitter</a></li>
            </ul>

            <h3><span>Latest Posts</span></h3>
            <ul>
                
                <li><a href="/archives/2011/06/06/the-web-column-issue-no5">The Web Column: Issue No.5</a></li>
                
                <li><a href="/archives/2011/02/09/the-web-column-issue-no4">The Web Column: Issue No.4</a></li>
                
                <li><a href="/archives/2011/02/08/contribute-to-the-web-column">Contribute to the Web Column</a></li>
                
                <li><a href="/archives/2011/01/18/the-web-column-issue-no3">The Web Column: Issue No.3</a></li>
                
                <li><a href="/archives/2011/01/14/the-web-column-issue-no2">The Web Column: Issue No.2</a></li>
                
            </ul>

            

            <h3><span>Tags</span></h3>
            <ul class="tags">
                
                    <li class="tag-10"><a href="/tag/performance/">performance</a></li>
                
                    <li class="tag-10"><a href="/tag/accessibility/">accessibility</a></li>
                
                    <li class="tag-10"><a href="/tag/cron/">cron</a></li>
                
                    <li class="tag-1"><a href="/tag/web-column/">web-column</a></li>
                
                    <li class="tag-10"><a href="/tag/browsers/">browsers</a></li>
                
                    <li class="tag-10"><a href="/tag/scaling/">scaling</a></li>
                
                    <li class="tag-10"><a href="/tag/linux/">linux</a></li>
                
                    <li class="tag-10"><a href="/tag/restructuredtext/">restructuredtext</a></li>
                
                    <li class="tag-10"><a href="/tag/haproxy/">haproxy</a></li>
                
                    <li class="tag-2"><a href="/tag/python/">python</a></li>
                
                    <li class="tag-10"><a href="/tag/glusterfs/">glusterfs</a></li>
                
                    <li class="tag-10"><a href="/tag/css/">css</a></li>
                
                    <li class="tag-3"><a href="/tag/apache/">apache</a></li>
                
                    <li class="tag-6"><a href="/tag/wsgi/">wsgi</a></li>
                
                    <li class="tag-6"><a href="/tag/mod_wsgi/">mod_wsgi</a></li>
                
                    <li class="tag-10"><a href="/tag/nginx/">nginx</a></li>
                
                    <li class="tag-10"><a href="/tag/google/">google</a></li>
                
                    <li class="tag-10"><a href="/tag/announcements/">announcements</a></li>
                
                    <li class="tag-10"><a href="/tag/loggerhead/">loggerhead</a></li>
                
                    <li class="tag-10"><a href="/tag/devops/">devops</a></li>
                
            </ul>

            <h3><span>More Fondue</span></h3>
            <ul>
                <li><a href="http://spritegen.website-performance.org">CSS Sprite Generator</a></li>
                <li><a href="http://favicon-generator.org">Favicon Generator</a></li>
                <li><a href="http://permissions-calculator.org">Unix Permissions Calculator</a></li>
            </ul>


        </aside>
        
    </div>

    <footer id="contentinfo" class="body" role="contentinfo">
        <p class="powered">Proudly powered by <a href="http://docs.notmyidea.org/alexis/pelican/">pelican</a></p>
        <p class="copyright">&copy; Copyright 2008-2012 by <a href="http://projectfondue.com/">Project Fondue</a>.</p>
    </footer><!-- /#contentinfo -->

    

<script type="text/javascript">
    var disqus_shortname = 'projectfondue';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>


    <script src="/theme/js/lscache.js"></script>
    <script src="/theme/js/latest-tweet.js"></script>
</body>
</html>